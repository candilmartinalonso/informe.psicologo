<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Comunicación para Terapia</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        // Configuración de Tailwind para el modo oscuro
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <style>
        /* Estilos base y personalizados */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Estilo para el placeholder del textarea */
        textarea::placeholder {
            color: #94a3b8; /* slate-400 */
        }
        .dark textarea::placeholder {
            color: #64748b; /* slate-500 */
        }

        /* Animación para la aparición suave de elementos */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* Animación de giro para el spinner */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }

        /* Estilos para la barra de desplazamiento */
        #respuesta-container::-webkit-scrollbar {
            width: 6px;
        }
        #respuesta-container::-webkit-scrollbar-track {
            background: transparent;
        }
        #respuesta-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 20px;
        }
        .dark #respuesta-container::-webkit-scrollbar-thumb {
            background-color: #475569; /* slate-600 */
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <!-- Contenedor principal -->
    <div class="flex flex-col items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
        
        <!-- Contenedor del contenido -->
        <div class="w-full max-w-3xl mx-auto space-y-8">
            
            <!-- Encabezado y selector de tema -->
            <header class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-blue-600 dark:text-blue-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.5A4.5 4.5 0 0 0 18 5c-1.5 0-2.75 1.06-4 1.06-1.25 0-2.5-1.06-4-1.06-3 0-6 8-6 12.5A4.5 4.5 0 0 0 6 18.5c1.25 0 2.5-1.06 4-1.06Z"/><path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.5A4.5 4.5 0 0 0 18 5c-1.5 0-2.75 1.06-4 1.06-1.25 0-2.5-1.06-4-1.06-3 0-6 8-6 12.5A4.5 4.5 0 0 0 6 18.5c1.25 0 2.5-1.06 4-1.06Z"/></svg>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-700 dark:text-slate-200">Asistente de Terapia</h1>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                    <svg id="theme-icon-light" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.95-4.243l-1.59-1.59M3 12h2.25m.386-6.364l1.59 1.591M12 12a6 6 0 100-12 6 6 0 000 12z" /></svg>
                    <svg id="theme-icon-dark" class="w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
                </button>
            </header>

            <main class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-6 sm:p-8 space-y-6">
                <!-- Introducción -->
                <div>
                    <h2 class="text-xl font-semibold text-slate-700 dark:text-slate-200">Describe tus pensamientos y emociones</h2>
                    <p class="text-slate-500 dark:text-slate-400 mt-1">Vuelca aquí tus ideas sin filtro. La IA te ayudará a estructurarlas en un mensaje claro y sincero para tu psicólogo.</p>
                </div>

                <!-- Área de texto del usuario -->
                <div class="relative">
                    <textarea id="entrada-usuario" rows="8" class="w-full p-4 bg-slate-100 dark:bg-slate-700 border-2 border-transparent rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-none" placeholder="Ej: Últimamente me siento muy ansioso/a, sobre todo por las mañanas. Me cuesta concentrarme en el trabajo y no duermo bien..."></textarea>
                     <button id="clear-btn" title="Limpiar texto" class="absolute bottom-3 right-3 p-1.5 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition-all duration-200 opacity-0 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>

                <!-- Botón de acción -->
                <div class="text-center">
                    <button id="generar-btn" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:ring-offset-slate-900 transition-all duration-200 disabled:bg-slate-400 dark:disabled:bg-slate-600 disabled:cursor-not-allowed flex items-center justify-center gap-3 mx-auto">
                        <svg id="btn-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.2 3.2a1 1 0 0 0-1.4 0l-10 10a1 1 0 0 0 0 1.4l2.5 2.5a1 1 0 0 0 1.4 0l10-10a1 1 0 0 0 0-1.4Z"/><path d="m13.5 6.5 5 5"/></svg>
                        <span id="btn-text">Redactar Mensaje</span>
                        <svg id="btn-spinner" class="w-5 h-5 spinner hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>

                <!-- Contenedor de resultados -->
                <div id="resultado-wrapper" class="hidden">
                    <div class="border-t border-slate-200 dark:border-slate-700 my-6"></div>
                    <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3">Mensaje sugerido:</h2>
                    <div id="respuesta-container" class="relative bg-slate-50 dark:bg-slate-900/50 p-4 border border-slate-200 dark:border-slate-700 rounded-lg min-h-[150px] max-h-72 overflow-y-auto">
                        <p id="respuesta-ia" class="text-slate-700 dark:text-slate-300 whitespace-pre-wrap leading-relaxed"></p>
                        <div id="copy-container" class="absolute top-2 right-2 opacity-0 transition-opacity duration-300">
                            <button id="copiar-btn" title="Copiar mensaje" class="p-2 bg-white/50 dark:bg-slate-700/50 backdrop-blur-sm rounded-md hover:bg-slate-200 dark:hover:bg-slate-600 transition duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-300">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                 <!-- Mensaje de error -->
                <div id="error-message" class="hidden text-center text-red-500 bg-red-100 dark:bg-red-900/30 p-3 rounded-lg"></div>
            </main>
        </div>
    </div>

    <!-- Toast de notificación -->
    <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-slate-900 dark:bg-slate-50 text-white dark:text-slate-900 py-2 px-5 rounded-full text-sm opacity-0 pointer-events-none transform translate-y-5 transition-all duration-300">
        <p>¡Mensaje copiado!</p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Referencias a elementos del DOM ---
        const entradaUsuarioEl = document.getElementById('entrada-usuario');
        const generarBtn = document.getElementById('generar-btn');
        const btnText = document.getElementById('btn-text');
        const btnIcon = document.getElementById('btn-icon');
        const btnSpinner = document.getElementById('btn-spinner');
        const resultadoWrapper = document.getElementById('resultado-wrapper');
        const respuestaIAEl = document.getElementById('respuesta-ia');
        const copiarBtn = document.getElementById('copiar-btn');
        const copyContainer = document.getElementById('copy-container');
        const toastEl = document.getElementById('toast');
        const clearBtn = document.getElementById('clear-btn');
        const errorMessageEl = document.getElementById('error-message');
        
        // --- Referencias para el selector de tema ---
        const themeToggle = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');

        let toastTimeout;

        // --- Lógica del Selector de Tema (Modo Oscuro/Claro) ---
        const updateTheme = () => {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            }
        };

        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.theme = isDark ? 'light' : 'dark';
            updateTheme();
        });

        // --- Lógica Principal de la Aplicación ---

        /**
         * Habilita o deshabilita el botón de generar y muestra/oculta el botón de limpiar.
         */
        const toggleButtons = () => {
            const hasText = entradaUsuarioEl.value.trim() !== '';
            generarBtn.disabled = !hasText;
            if (hasText) {
                clearBtn.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                clearBtn.classList.add('opacity-0', 'pointer-events-none');
            }
        };

        /**
         * Limpia el área de texto y oculta los resultados.
         */
        const clearInput = () => {
            entradaUsuarioEl.value = '';
            resultadoWrapper.classList.add('hidden');
            errorMessageEl.classList.add('hidden');
            toggleButtons();
            entradaUsuarioEl.focus();
        };

        /**
         * Muestra un toast de notificación.
         */
        const mostrarToast = () => {
            clearTimeout(toastTimeout);
            toastEl.classList.remove('opacity-0', 'translate-y-5');
            toastTimeout = setTimeout(() => {
                toastEl.classList.add('opacity-0', 'translate-y-5');
            }, 2500);
        };

        /**
         * Copia el texto generado al portapapeles.
         */
        const copiarTexto = () => {
            const texto = respuestaIAEl.textContent;
            if (!texto) return;
            // Usa document.execCommand para compatibilidad con el iframe
            const textArea = document.createElement("textarea");
            textArea.value = texto;
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                mostrarToast();
            } catch (err) {
                console.error('No se pudo copiar el texto: ', err);
            }
            document.body.removeChild(textArea);
        };

        /**
         * Establece el estado de carga de la aplicación.
         * @param {boolean} isLoading - Si la aplicación está cargando.
         */
        const setLoadingState = (isLoading) => {
            generarBtn.disabled = isLoading;
            btnText.classList.toggle('hidden', isLoading);
            btnIcon.classList.toggle('hidden', isLoading);
            btnSpinner.classList.toggle('hidden', !isLoading);
            entradaUsuarioEl.disabled = isLoading;
        };
        
        /**
         * Muestra un mensaje de error.
         * @param {string} message - El mensaje de error a mostrar.
         */
        const mostrarError = (message) => {
            errorMessageEl.textContent = message;
            errorMessageEl.classList.remove('hidden');
            resultadoWrapper.classList.add('hidden');
        };

        /**
         * Llama a la IA para generar el mensaje.
         */
        const generarMensaje = async () => {
            const textoUsuario = entradaUsuarioEl.value.trim();
            if (!textoUsuario) return;

            setLoadingState(true);
            errorMessageEl.classList.add('hidden');
            resultadoWrapper.classList.add('hidden');
            
            const prompt = `Actúa como un asistente de comunicación empático y experto. Mi objetivo es comunicarle a mi psicólogo cómo me he sentido, pero me cuesta encontrar las palabras adecuadas. A partir de mis siguientes pensamientos y emociones, que te proporciono de forma desordenada y sincera:
---
"${textoUsuario}"
---
Tu tarea es redactar en primera persona el párrafo exacto que podría decirle o enviarle a mi psicólogo.
Requisitos del texto final:
- Debe ser claro, directo y conciso.
- Tiene que sonar auténtico y reflejar sinceridad.
- La estructura debe ser coherente, organizando mis ideas de forma lógica.
- No incluyas saludos, despedidas, ni explicaciones sobre el propósito del texto (ej. "Aquí te envío un resumen...").
- Simplemente, entrégame el párrafo listo para que yo lo pueda usar directamente.`;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "" 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Error de la API: ${response.statusText}`);
                }
                
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    mostrarRespuesta(text.trim());
                } else {
                    throw new Error("La respuesta de la IA no tuvo el formato esperado.");
                }

            } catch (error) {
                console.error("Error al generar el mensaje:", error);
                mostrarError("No se pudo generar el mensaje. Por favor, inténtalo de nuevo más tarde.");
            } finally {
                setLoadingState(false);
            }
        };

        /**
         * Muestra la respuesta con un efecto de escritura.
         * @param {string} text - El texto a mostrar.
         */
        const mostrarRespuesta = (text) => {
            resultadoWrapper.classList.remove('hidden');
            resultadoWrapper.classList.add('fade-in');
            respuestaIAEl.textContent = '';
            copyContainer.classList.add('opacity-0');

            let i = 0;
            function typeWriter() {
                if (i < text.length) {
                    respuestaIAEl.textContent += text.charAt(i);
                    i++;
                    // Acelera la escritura para textos largos
                    const delay = text.length > 200 ? 5 : 15;
                    setTimeout(typeWriter, delay);
                } else {
                    // Muestra el botón de copiar cuando termina
                    copyContainer.classList.remove('opacity-0');
                }
            }
            typeWriter();
        };

        // --- Asignación de Eventos ---
        entradaUsuarioEl.addEventListener('input', toggleButtons);
        generarBtn.addEventListener('click', generarMensaje);
        copiarBtn.addEventListener('click', copiarTexto);
        clearBtn.addEventListener('click', clearInput);

        // --- Estado Inicial ---
        updateTheme();
        toggleButtons();
    });
    </script>
</body>
</html>
